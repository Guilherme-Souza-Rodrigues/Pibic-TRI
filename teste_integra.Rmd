---

indent: yes

output:

  html_document:

    df_print: paged

  pdf_document: default

---



Primeiramente, apresentaremos alguns gráficos descritivos do desempenho dos alunos de PE durante o semestre e ao longo deste, com análises por turma, curso e número da prova.



Logo após, avaliaremos a qualidade das quatro provas aplicadas aos alunos de acordo com uma calibração adequada para o nível de dificuldade das questões selecionadas para cada turma.



Finalmente, uma análise via TRI será apresentada, verificando caso os temas de cada prova estão realmente relacionados entre si (clusterização), e uma comparação entre a a avaliação por TRI e a Clássica, investigando se haveria algum benefício na utilização daquele.



```{r echo=FALSE, cache=TRUE, warning=FALSE, message=FALSE, results='hide'}

#Lendo os dados das provas e carregando os pacotes:

if(length(ls()) > 0) rm(list = ls())

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally", "pander")



dados.original <-read.csv("D:/PIBIC_GUILHERME/Banco_respostas.csv",
                 sep=";", stringsAsFactors=FALSE)



# Correção do nome dos Cursos

dados.original$Curso <- gsub("Ã¢","â",dados.original$Curso)

dados.original$Curso <- gsub("Ã§Ã£","çã",dados.original$Curso)

dados.original$Curso <- gsub("Ã","í",dados.original$Curso)

dados.original$Curso <- gsub("Engenharia Quí.....","Engenharia Química",dados.original$Curso)

dados.original$Curso <- gsub("Educação Fí.....","Educação Física",dados.original$Curso)

dados.original$Curso <- gsub("íª","ê",dados.original$Curso)

dados.original$Curso <- gsub("í´","ô",dados.original$Curso)

dados.original$Curso <- gsub("í©","é",dados.original$Curso)



dados.original$Tema <- gsub("...medida_probabilidade.......", "medida_probabilidade", dados.original$Nome.questao)

dados.original$Tema <- gsub("...propriedade_probabilidade.......", "propriedade_probabilidade", dados.original$Tema)

dados.original$Tema <- gsub("...probabilidade_total.......", "probabilidade_total", dados.original$Tema)

dados.original$Tema <- gsub("...teorema_Bayes.......", "teorema_Bayes", dados.original$Tema)

dados.original$Tema <- gsub("...variaveis_aleatorias.......", "variaveis_aleatorias", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_binomial.......", "distribuicao_binomial", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_geometrica.......", "distribuicao_geometrica", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_hipergeometrica.......", "distribuicao_hipergeometrica", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_poisson.......", "distribuicao_poisson", dados.original$Tema)

dados.original$Tema <- gsub("...aproximacao_poisson_binomial.......", "aproximacao_poisson_binomial", dados.original$Tema)

dados.original$Tema <- gsub("...funcao_densidade.......", "funcao_densidade", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_acumulada.......", "distribuicao_acumulada", dados.original$Tema)

dados.original$Tema <- gsub("...momentos.......", "momentos", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_exponencial.......", "distribuicao_exponencial", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_normal.......", "distribuicao_normal", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_normal...", "distribuicao_normal", dados.original$Tema)

dados.original$Tema <- gsub("...aproximacao_normal_binomial.......", "aproximacao_normal_binomial", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_condicional.......", "distribuicao_condicional", dados.original$Tema)

dados.original$Tema <- gsub("...covariancia_correlacao.......", "covariancia_correlacao", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_media.......", "distribuicao_media", dados.original$Tema)

dados.original$Tema <- gsub("...distribuicao_proporcao.......", "distribuicao_proporcao", dados.original$Tema)

dados.original$Tema <- gsub("...maxima_verossimilhanca.......", "maxima_verossimilhanca", dados.original$Tema)

dados.original$Tema <- gsub("...IC_media_normal.......", "IC_media_normal", dados.original$Tema)

dados.original$Tema <- gsub("...IC_media_t.......", "IC_media_t", dados.original$Tema)

dados.original$Tema <- gsub("...IC_proporção.......", "IC_proporção", dados.original$Tema)

dados.original$Tema <- gsub("...IC_proporcao.......", "IC_proporção", dados.original$Tema)

dados.original$Tema <- gsub("...TH_media.......", "TH_media", dados.original$Tema)

dados.original$Tema <- gsub("...tamanho_media.......", "tamanho_media", dados.original$Tema)

dados.original$Tema <- gsub("...TH_proporcao.......", "TH_proporcao", dados.original$Tema)

dados.original$Tema <- gsub("...pvalor_media.......", "pvalor_media", dados.original$Tema)

dados.original$Tema <- gsub("...tamanho_prop.......", "tamanho_prop", dados.original$Tema)

dados.original$Tema <- gsub("...pvalor_proporcao.......", "pvalor_proporcao", dados.original$Tema)

dados.original$Tema <- gsub("...valor_esperado_e_variancia.......", "valor_esperado_e_variancia", dados.original$Tema)





n.questoes.prova <- 10

n.mcmc <- 1000

thin.mcmc <- 10

n.turmas <- length(unique(dados.original$Turma))

n.provas <- length(unique(dados.original$Numero.prova))

turmas <- c("AA","AB","BA","BB","CA","CB","CC","DA","DB","EA")



#Criando o mapa de questões

mapa.questoes <- array(dim=c(n.turmas, n.questoes.prova, n.provas), 

                        dimnames=list(unique(dados.original$Turma)[order(unique(dados.original$Turma))], paste("Questao", 1:n.questoes.prova), paste("Prova", 1:n.provas)))



for(prova in 1:n.provas) {

  mapa.questoes[,,prova] <- dplyr::filter(dados.original, Numero.prova==prova) %>%

    dplyr::select(Turma, Questao, Nome.questao) %>% 

    unique() %>% 

    dcast(Turma ~ Questao, value.var="Nome.questao") %>%  

    #dplyr::filter(., complete.cases(.)) %>%

    as.matrix() %>% 

    .[, -1]

}





#Criando dataframe com as respostas dicotômicas de cada aluno:

dico <- vector(n.provas, mode="list")



for(prova in 1:n.provas) {

data <- dados.original[order(dados.original$Matricula), ] %>%

  dplyr::filter(Numero.prova==prova) %>%

  droplevels()

matricula <- data$Matricula

acerto <- as.numeric(data$Acertou)

questao <- data$Nome.questao

turma <- data$Turma

frame <- data.frame(matricula,acerto,questao,turma) %>% 

  dplyr::filter(., complete.cases(.))

dico[[prova]] <- reshape(frame, v.names = "acerto", idvar = "matricula", timevar="questao", 

                direction="wide")

colnames(dico[[prova]]) <- gsub("^acerto.*?.","",colnames(dico[[prova]]))

}



#Cálculo dos estimadores dos parâmetros dos itens e do estimador do parâmetro de habilidade de

#cada aluno via Monte Carlo Cadeia de Markov:

set.seed(120173344)

model <- stan_model(model_code = 
"data {
  int<lower=1> N_alunos;              // number of students
  int<lower=1> N_itens;              // number of questions
  int<lower=1> N;                   // number of observations
  int<lower=1,upper=N_alunos> aluno[N];   // student for observation n
  int<lower=1,upper=N_itens> item[N];   // question for observation n
  int<lower=0,upper=1> y[N];     // correctness for observation n
}
parameters{
  vector[N_itens] b;
  vector<lower=0,upper=1>[N_itens] c;
  vector[N_alunos] theta;
  vector<lower=0>[N_itens] a;
}
model{
  a~normal(0,1);
  b~normal(0,1);
  c~beta(5,17);
  theta~normal(0,1);
  y~bernoulli(c[item]+((1-c[item]).*inv_logit((a[item] .*theta[aluno])-b[item])));
}"
)
###################################################

banco_respostas <- dados.original%>%
  dplyr::select(Matricula,Nome.questao,Acertou,Numero.prova)

###############################
###  Parâmetros das simulações
###############################
nchains <- 4
niter <- 1000

##############
#  P1
##############

dados_p1 <- banco_respostas%>%
  filter(Numero.prova==1)%>%
  na.omit(Acertou)%>%
  mutate(Matricula.mod=as.numeric(as.factor(Matricula)),
         Nome.questao.mod=as.numeric(as.factor(Nome.questao)))%>%
  arrange(Matricula.mod,Nome.questao.mod)

Matriculas_equivalencia_p1 <- dados_p1%>%
  dplyr::select(Matricula,Matricula.mod)%>%
  distinct()%>%
  arrange(Matricula.mod)

Questoes_equivalencia_p1 <- dados_p1%>%
  dplyr::select(Nome.questao,Nome.questao.mod)%>%
  distinct()%>%
  arrange(Nome.questao.mod)
fit.p1 <- sampling(object=model,data=list(N_alunos=length(unique(dados_p1$Matricula.mod)),
                                          N_itens=length(unique(dados_p1$Nome.questao.mod)),
                                          N=nrow(dados_p1),
                                          aluno=dados_p1$Matricula.mod,
                                          item=dados_p1$Nome.questao.mod, 
                                          y=dados_p1$Acertou),iter=niter,chains=nchains,cores=4)
params.p1 <- rstan::extract(fit.p1)
a_p1 <-cbind(Questoes_equivalencia_p1,a=colMeans(params.p1$a),prova=1)
b_p1 <-cbind(Questoes_equivalencia_p1,b=colMeans(params.p1$b),prova=1)
c_p1 <-cbind(Questoes_equivalencia_p1,c=colMeans(params.p1$c),prova=1)
theta_p1 <-cbind(Matriculas_equivalencia_p1,theta1=colMeans(params.p1$theta))

itens.p1 <- array(c(params.p1$a,params.p1$b,params.p1$c),
                  dim = c(nchains*(niter/2) , nrow(Questoes_equivalencia_p1), 3),
                  dimnames = list(paste("simulação",1:(nchains*(niter/2))),
                                  Questoes_equivalencia_p1$Nome.questao,
                                  c('a','b','c')))
thetas.mcmc.p1 <- params.p1$theta
colnames(thetas.mcmc.p1) <- Matriculas_equivalencia_p1$Matricula

rm(Questoes_equivalencia_p1,Matriculas_equivalencia_p1,dados_p1,fit.p1)
##############
#  P2
##############
dados_p2 <- banco_respostas%>%
  filter(Numero.prova==2)%>%
  na.omit(Acertou)%>%
  mutate(Matricula.mod=as.numeric(as.factor(Matricula)),
         Nome.questao.mod=as.numeric(as.factor(Nome.questao)))%>%
  arrange(Matricula.mod,Nome.questao.mod)

Matriculas_equivalencia_p2 <- dados_p2%>%
  dplyr::select(Matricula,Matricula.mod)%>%
  distinct()%>%
  arrange(Matricula.mod)

Questoes_equivalencia_p2 <- dados_p2%>%
  dplyr::select(Nome.questao,Nome.questao.mod)%>%
  distinct()%>%
  arrange(Nome.questao.mod)
fit.p2 <- sampling(object=model,data=list(N_alunos=length(unique(dados_p2$Matricula.mod)),
                                          N_itens=length(unique(dados_p2$Nome.questao.mod)),
                                          N=nrow(dados_p2),
                                          aluno=dados_p2$Matricula.mod,
                                          item=dados_p2$Nome.questao.mod, 
                                          y=dados_p2$Acertou),iter=niter,chains=nchains,cores=4)
params.p2 <- rstan::extract(fit.p2)
a_p2 <-cbind(Questoes_equivalencia_p2,a=colMeans(params.p2$a),prova=2)
b_p2 <-cbind(Questoes_equivalencia_p2,b=colMeans(params.p2$b),prova=2)
c_p2 <-cbind(Questoes_equivalencia_p2,c=colMeans(params.p2$c),prova=2)
theta_p2 <-cbind(Matriculas_equivalencia_p2,theta2=colMeans(params.p2$theta))

itens.p2 <- array(c(params.p2$a,params.p2$b,params.p2$c),
                  dim = c(nchains*(niter/2) , nrow(Questoes_equivalencia_p2), 3),
                  dimnames = list(paste("simulação",1:(nchains*(niter/2))),
                                  Questoes_equivalencia_p2$Nome.questao,
                                  c('a','b','c')))

thetas.mcmc.p2 <- params.p2$theta
colnames(thetas.mcmc.p2) <- Matriculas_equivalencia_p2$Matricula

rm(Questoes_equivalencia_p2,Matriculas_equivalencia_p2,dados_p2,fit.p2)
##############
#  P3
##############
dados_p3 <- banco_respostas%>%
  filter(Numero.prova==3)%>%
  na.omit(Acertou)%>%
  mutate(Matricula.mod=as.numeric(as.factor(Matricula)),
         Nome.questao.mod=as.numeric(as.factor(Nome.questao)))%>%
  arrange(Matricula.mod,Nome.questao.mod)

Matriculas_equivalencia_p3 <- dados_p3%>%
  dplyr::select(Matricula,Matricula.mod)%>%
  distinct()%>%
  arrange(Matricula.mod)

Questoes_equivalencia_p3 <- dados_p3%>%
  dplyr::select(Nome.questao,Nome.questao.mod)%>%
  distinct()%>%
  arrange(Nome.questao.mod)
fit.p3 <- sampling(object=model,data=list(N_alunos=length(unique(dados_p3$Matricula.mod)),
                                          N_itens=length(unique(dados_p3$Nome.questao.mod)),
                                          N=nrow(dados_p3),
                                          aluno=dados_p3$Matricula.mod,
                                          item=dados_p3$Nome.questao.mod, 
                                          y=dados_p3$Acertou),iter=niter,chains=nchains,cores=4)
params.p3 <- rstan::extract(fit.p3)
a_p3 <-cbind(Questoes_equivalencia_p3,a=colMeans(params.p3$a),prova=3)
b_p3 <-cbind(Questoes_equivalencia_p3,b=colMeans(params.p3$b),prova=3)
c_p3 <-cbind(Questoes_equivalencia_p3,c=colMeans(params.p3$c),prova=3)
theta_p3 <-cbind(Matriculas_equivalencia_p3,theta3=colMeans(params.p3$theta))

itens.p3 <- array(c(params.p3$a,params.p3$b,params.p3$c),
                  dim = c(nchains*(niter/2) , nrow(Questoes_equivalencia_p3), 3),
                  dimnames = list(paste("simulação",1:(nchains*(niter/2))),
                                  Questoes_equivalencia_p3$Nome.questao,
                                  c('a','b','c')))

thetas.mcmc.p3 <- params.p3$theta
colnames(thetas.mcmc.p3) <- Matriculas_equivalencia_p3$Matricula

rm(Questoes_equivalencia_p3,Matriculas_equivalencia_p3,dados_p3,fit.p3)
##############
#  P4-subs
##############
dados_p4 <- banco_respostas%>%
  filter(Numero.prova==4)%>%
  na.omit(Acertou)%>%
  mutate(Matricula.mod=as.numeric(as.factor(Matricula)),
         Nome.questao.mod=as.numeric(as.factor(Nome.questao)))%>%
  arrange(Matricula.mod,Nome.questao.mod)

Matriculas_equivalencia_p4 <- dados_p4%>%
  dplyr::select(Matricula,Matricula.mod)%>%
  distinct()%>%
  arrange(Matricula.mod)

Questoes_equivalencia_p4 <- dados_p4%>%
  dplyr::select(Nome.questao,Nome.questao.mod)%>%
  distinct()%>%
  arrange(Nome.questao.mod)
fit.p4 <- sampling(object=model,data=list(N_alunos=length(unique(dados_p4$Matricula.mod)),
                                          N_itens=length(unique(dados_p4$Nome.questao.mod)),
                                          N=nrow(dados_p4),
                                          aluno=dados_p4$Matricula.mod,
                                          item=dados_p4$Nome.questao.mod, 
                                          y=dados_p4$Acertou),iter=niter,chains=nchains,cores=4)
params.p4 <- rstan::extract(fit.p4)
a_p4 <-cbind(Questoes_equivalencia_p4,a=colMeans(params.p4$a),prova=4)
b_p4 <-cbind(Questoes_equivalencia_p4,b=colMeans(params.p4$b),prova=4)
c_p4 <-cbind(Questoes_equivalencia_p4,c=colMeans(params.p4$c),prova=4)
theta_p4 <-cbind(Matriculas_equivalencia_p4,theta4=colMeans(params.p4$theta))

itens.p4 <- array(c(params.p4$a,params.p4$b,params.p4$c),
                  dim = c(nchains*(niter/2) , nrow(Questoes_equivalencia_p4), 3),
                  dimnames = list(paste("simulação",1:(nchains*(niter/2))),
                                  Questoes_equivalencia_p4$Nome.questao,
                                  c('a','b','c')))

thetas.mcmc.p4 <- params.p4$theta
colnames(thetas.mcmc.p4) <- Matriculas_equivalencia_p4$Matricula

rm(Questoes_equivalencia_p4,Matriculas_equivalencia_p4,dados_p4,fit.p4)
#########################
#  Juntando tudo
#########################
a <- rbind(a_p1,a_p2,a_p3,a_p4)
b <- rbind(b_p1,b_p2,b_p3,b_p4)
c <- rbind(c_p1,c_p2,c_p3,c_p4)

theta <- left_join(theta_p1,theta_p2,"Matricula")%>%
  left_join(theta_p3,"Matricula")%>%
  left_join(theta_p4,"Matricula")%>%
  dplyr::select(Matricula,theta1,theta2,theta3,theta4)
rm(a_p1,a_p2,a_p3,a_p4,
   b_p1,b_p2,b_p3,b_p4,
   c_p1,c_p2,c_p3,c_p4,
   theta_p1,theta_p2,theta_p3,theta_p4)
alunos <- theta

itens <- cbind(a[,c("Nome.questao","prova","a")],b=b[,"b"],c=c[,"c"])%>%
  dplyr::select(Nome.questao,a,b,c,prova)%>%
  mutate(Nome.questao=str_remove(Nome.questao,".Rnw"))%>%
  mutate(questao=str_sub(Nome.questao,str_length(Nome.questao)-1),
         tema=str_sub(Nome.questao,4,str_length(Nome.questao)-3))%>%
  dplyr::select(-Nome.questao)

itens <- itens[,c("a","b","c","prova","tema","questao")]%>%
  arrange(prova)

itens_tabela <- itens

mcmc.itens <- list(itens.p1,itens.p2,itens.p3,itens.p4)
mcmc.theta <- list(thetas.mcmc.p1,thetas.mcmc.p2,thetas.mcmc.p3,thetas.mcmc.p4)

itens.p <- list(prova1=subset(itens,prova==1,select = -prova),
            prova2=subset(itens,prova==2,select = -prova),
            prova3=subset(itens,prova==3,select = -prova),
            prova4=subset(itens,prova==4,select = -prova))

list_of_datasets <- list("Prova 1" = itens.p[[1]], "Prova 2" = itens.p[[2]],
                         
                         "Prova 3" = itens.p[[3]], "Prova 4" = itens.p[[4]])





# Simulação com as probabilidade de que um aluno mediano acerte a questão para cada questão 

#selecionada em cada prova

Pm.probs <- vector(n.provas, mode="list")

names(Pm.probs) <- paste0("Prova", 1:n.provas)



for (prova in 1:n.provas){

  Pm.probs[[prova]] <- array(c(as.numeric(mcmc.itens[[prova]][,,3]) +                   

                       (1-as.numeric(mcmc.itens[[prova]][,,3]))*

                       pnorm(-as.numeric(mcmc.itens[[prova]][,,2]))),dim=c(nchains*(niter/2), ncol(dico[[prova]])-2), 

                       dimnames=list(paste("Simulacao", 1:(nchains*(niter/2))),

                              colnames(dico[[prova]][, -c(1,2)])))

}





# Probabilidade de acerto de cada questão feita por cada aluno

P.probs <- vector(n.provas, mode="list")

names(P.probs) <- paste0("Prova", 1:n.provas)



for (prova in 1:n.provas){

  P.probs[[prova]] <- matrix(0, nrow = nrow(dico[[prova]]), ncol=ncol(dico[[prova]][, -c(1,2)]))

  for (aluno in 1:nrow(dico[[prova]])){



P.probs[[prova]][aluno,] <- c(

  itens.p[[prova]][,3] + (1-itens.p[[prova]][,3])*

    pnorm(itens.p[[prova]][,1]*colMeans(mcmc.theta[[prova]])[aluno] - itens.p[[prova]][,2])

)



P.probs[[prova]] <- data.frame(P.probs[[prova]])

rownames(P.probs[[prova]]) <- colnames(mcmc.theta[[prova]])

colnames(P.probs[[prova]]) <- colnames(dico[[prova]][, -c(1,2)])



        

  }

}





# Dataframes de cada prova com a probabilidade de acerto por tema (questão que o aluno fez do tema) para cada aluno 



Prob.tema1 <- matrix(0, nrow=ncol(mcmc.theta[[1]]), ncol=n.questoes.prova)

for (aluno in 1:ncol(mcmc.theta[[1]])){

  Prob.tema1 <- data.frame(Prob.tema1)

  

  turma <- dados.original %>% 

    dplyr::filter(Numero.prova==1, Matricula==colnames(mcmc.theta[[1]])[aluno]) %>% 

    dplyr::select(Turma) %>% unique()

  turma <- turma[1,1]

  

  questoes <- dados.original %>% 

    dplyr::filter(Numero.prova==1, Matricula==colnames(mcmc.theta[[1]])[aluno]) %>% 

    dplyr::select(Nome.questao, Acertou) %>% unique()

  

  questoes <- as.character(questoes[is.na(questoes$Acertou)==FALSE,1])

  

  p <- P.probs[[1]][aluno, questoes]

  

  a = p[order(names(p))]

  

  at <- which(!(seq(1,10) %in% as.numeric(substring(names(a), 1,2))))

  

  if(length(at)==0) {Prob.tema1[aluno, ] <- a} 

  else if(length(at)==1){Prob.tema1[aluno, ] <- insert(unlist(c(a)), at, NA)}

  else if(length(at)==2){Prob.tema1[aluno, ] <- insert(insert(unlist(c(a)), at[1], NA), at[2], NA)}

  

}



rownames(Prob.tema1) <- colnames(mcmc.theta[[1]])

colnames(Prob.tema1) <- substring(names(a), 4, nchar(names(a))-7)



Prob.tema2 <- matrix(0, nrow=ncol(mcmc.theta[[2]]), ncol=n.questoes.prova)

for (aluno in 1:ncol(mcmc.theta[[2]])){

  Prob.tema2 <- data.frame(Prob.tema2)

  

  turma <- dados.original %>% 

    dplyr::filter(Numero.prova==2, Matricula==colnames(mcmc.theta[[2]])[aluno]) %>% 

    dplyr::select(Turma) %>% unique()

  turma <- turma[1,1]

  

  questoes <- dados.original %>% 

    dplyr::filter(Numero.prova==2, Matricula==colnames(mcmc.theta[[2]])[aluno]) %>% 

    dplyr::select(Nome.questao, Acertou) %>% unique()

  

  questoes <- as.character(questoes[is.na(questoes$Acertou)==FALSE,1])

  

  p <- P.probs[[2]][aluno, questoes]

  

  a = p[order(names(p))]

  

  at <- which(!(seq(11,20) %in% as.numeric(substring(names(a), 1,2))))

  

  if(length(at)==0) {Prob.tema2[aluno, ] <- a} 

  else if(length(at)==1){Prob.tema2[aluno, ] <- insert(unlist(c(a)), at, NA)}

  else if(length(at)==2){Prob.tema2[aluno, ] <- insert(insert(unlist(c(a)), at[1], NA), at[2], NA)}

  

}



rownames(Prob.tema2) <- colnames(mcmc.theta[[2]])

colnames(Prob.tema2) <- substring(names(a), 4, nchar(names(a))-7)





Prob.tema3 <- matrix(0, nrow=ncol(mcmc.theta[[3]]), ncol=n.questoes.prova)

for (aluno in 1:ncol(mcmc.theta[[3]])){

  Prob.tema3 <- data.frame(Prob.tema3)

  

  turma <- dados.original %>% 

    dplyr::filter(Numero.prova==3, Matricula==colnames(mcmc.theta[[3]])[aluno]) %>% 

    dplyr::select(Turma) %>% unique()

  turma <- turma[1,1]

  

  questoes <- dados.original %>% 

    dplyr::filter(Numero.prova==3, Matricula==colnames(mcmc.theta[[3]])[aluno]) %>% 

    dplyr::select(Nome.questao, Acertou) %>% unique()

  

  questoes <- as.character(questoes[is.na(questoes$Acertou)==FALSE,1])

  

  p <- P.probs[[3]][aluno, questoes]

  

  a = p[order(names(p))]

  

  at <- which(!(seq(21,30) %in% as.numeric(substring(names(a), 1,2))))

  

  if(length(at)==0) {Prob.tema3[aluno, ] <- a} 

  else if(length(at)==1){Prob.tema3[aluno, ] <- insert(unlist(c(a)), at, NA)}

  else if(length(at)==2){Prob.tema3[aluno, ] <- insert(insert(unlist(c(a)), at[1], NA), at[2], NA)}

  

}



rownames(Prob.tema3) <- colnames(mcmc.theta[[3]])

colnames(Prob.tema3) <- substring(names(a), 4, nchar(names(a))-7)





Prob.tema1$Matricula <- colnames(mcmc.theta[[1]])

Prob.tema2$Matricula <- colnames(mcmc.theta[[2]])

Prob.tema3$Matricula <- colnames(mcmc.theta[[3]])



Prob.acerto.tema <- full_join(Prob.tema1, Prob.tema2, by="Matricula")

Prob.acerto.tema <- full_join(Prob.acerto.tema, Prob.tema3, by="Matricula")

rownames(Prob.acerto.tema) <- Prob.acerto.tema[,11]

Prob.acerto.tema <- Prob.acerto.tema[,-11]





Acertou.tema1 <- matrix(0, nrow=ncol(mcmc.theta[[1]]), ncol=n.questoes.prova)

for (aluno in 1:ncol(mcmc.theta[[1]])){

 tx <- dados.original %>% 

  dplyr::filter(Numero.prova==1, Matricula==as.numeric(colnames(mcmc.theta[[1]])[aluno])) %>% 

  dplyr::select(Acertou, Matricula, Tema, Nome.questao)

 tix <- tx[,1]

 names(tix) <- tx[,4]

 tix <- tix[order(names(tix))]

 at <- which(!(seq(1,10) %in% as.numeric(substring(names(tix), 1,2))))

  

  if(length(at)==0) {Acertou.tema1[aluno,] <- tix} 

  else if(length(at)==1){Acertou.tema1[aluno, ] <- insert(tix, at, NA)}

  else if(length(at)==2){Acertou.tema1[aluno, ] <- insert(insert(tix, at, NA), at[2], NA)}

 

}

Acertou.tema1 <- data.frame(Acertou.tema1)

rownames(Acertou.tema1) <- colnames(mcmc.theta[[1]])

colnames(Acertou.tema1) <- substring(names(tix), 4, nchar(names(tix))-7)



Acertou.tema2 <- matrix(0, nrow=ncol(mcmc.theta[[2]]), ncol=n.questoes.prova)

for (aluno in 1:ncol(mcmc.theta[[2]])){

 tx <- dados.original %>% 

  dplyr::filter(Numero.prova==2, Matricula==as.numeric(colnames(mcmc.theta[[2]])[aluno])) %>% 

  dplyr::select(Acertou, Matricula, Tema, Nome.questao)

 tix <- tx[,1]

 names(tix) <- tx[,4]

 tix <- tix[order(names(tix))]

 at <- which(!(seq(11,20) %in% as.numeric(substring(names(tix), 1,2))))

  

  if(length(at)==0) {Acertou.tema2[aluno,] <- tix} 

  else if(length(at)==1){Acertou.tema2[aluno, ] <- insert(tix, at, NA)}

  else if(length(at)==2){Acertou.tema2[aluno, ] <- insert(insert(tix, at, NA), at[2], NA)}

 

}

Acertou.tema2 <- data.frame(Acertou.tema2)

rownames(Acertou.tema2) <- colnames(mcmc.theta[[2]])

colnames(Acertou.tema2) <- substring(names(tix), 4, nchar(names(tix))-7)





Acertou.tema3 <- matrix(0, nrow=ncol(mcmc.theta[[3]]), ncol=n.questoes.prova)

for (aluno in 1:ncol(mcmc.theta[[3]])){

 tx <- dados.original %>% 

  dplyr::filter(Numero.prova==3, Matricula==as.numeric(colnames(mcmc.theta[[3]])[aluno])) %>% 

  dplyr::select(Acertou, Matricula, Tema, Nome.questao)

 tix <- tx[,1]

 names(tix) <- tx[,4]

 tix <- tix[order(names(tix))]

 at <- which(!(seq(21,30) %in% as.numeric(substring(names(tix), 1,2))))

  

  if(length(at)==0) {Acertou.tema3[aluno,] <- tix} 

  else if(length(at)==1){Acertou.tema3[aluno, ] <- insert(tix, at, NA)}

  else if(length(at)==2){Acertou.tema3[aluno, ] <- insert(insert(tix, at, NA), at[2], NA)}

 

}

Acertou.tema3 <- data.frame(Acertou.tema3)

rownames(Acertou.tema3) <- colnames(mcmc.theta[[3]])

colnames(Acertou.tema3) <- substring(names(tix), 4, nchar(names(tix))-7)





Acertou.tema1$Matricula <- colnames(mcmc.theta[[1]])

Acertou.tema2$Matricula <- colnames(mcmc.theta[[2]])

Acertou.tema3$Matricula <- colnames(mcmc.theta[[3]])



Acerto.tema <- full_join(Acertou.tema1, Acertou.tema2, by="Matricula")

Acerto.tema <- full_join(Acerto.tema, Acertou.tema3, by="Matricula")

rownames(Acerto.tema) <- Acerto.tema[,11]

Acerto.tema <- Acerto.tema[,-11]



Acerto.tema.0 <- Acerto.tema

Acerto.tema.0[is.na(Acerto.tema.0)] <- 0



Prob.acerto.tema.0 <- Prob.acerto.tema

Prob.acerto.tema.0[is.na(Prob.acerto.tema.0)] <- 0



#H.hat <- var(2*(Acerto.tema*log(Acerto.tema/Prob.acerto.tema) + (1-Acerto.tema)*log(1/(1-Prob.acerto.tema))), na.rm = T)





cd <- matrix(0, nrow=nrow(Acerto.tema), ncol=30)

for (aluno in 1:nrow(Acerto.tema)){

for (tema in 1:30){

  if(is.na(Acerto.tema[aluno,tema])){cd[aluno,tema] <- NA}

else if(Acerto.tema[aluno,tema]==1){cd[aluno,tema] <- -2*abs(log(Prob.acerto.tema[aluno,tema]))^.5}  

else if(Acerto.tema[aluno,tema]==0){cd[aluno,tema] <- -2*abs(log(1-Prob.acerto.tema[aluno,tema]))^.5}

}

}

cd <- data.frame(cd)

rownames(cd) <- rownames(Acerto.tema)

colnames(cd) <- colnames(Acerto.tema)



cd.0 <- cd[complete.cases(cd),]





cor.tema <- matrix(0, nrow=30, ncol=30)

for (tema in 1:30){

  for (tema2 in 1:30){

  cor.tema[tema,tema2] <- 

    cor(cd[complete.cases(cd[,c(tema,tema2)]),tema], cd[complete.cases(cd[,c(tema,tema2)]),tema2])

  }

}

cor.tema <- data.frame(cor.tema)

rownames(cor.tema) <- colnames(Acerto.tema)

colnames(cor.tema) <- colnames(Acerto.tema)





cluster <- kmeans(t(cor.tema), 3) 

# distribuicao_geometrica (1 -> 2),  funcao_densidade (2 -> 3), valor_esperado_e_variancia (2 -> 3), distribuicao_exponencial (2 -> 1), distribuicao_normal (2 -> 3), distribuicao_condicional (2 -> 1)





#Array final para o balanceamento das provas, com o número de simulações, turmas, questões,

#provas e vetor com a probabilidade de acerto e o resultado da binomial se acertou ou não:



n.sim <- n.mcmc/thin.mcmc



dados.balanceamento <- array(dim=c(nchains*(niter/2), n.turmas, n.questoes.prova, n.provas, 2),

                             dimnames = list(dimnames(mcmc.itens[[prova]])[[1]],

                               dimnames(mapa.questoes)[[1]],

                               dimnames(mapa.questoes)[[2]],

                               dimnames(mapa.questoes)[[3]],

                               c("prob.acerto", "sim.acerto")))



for(questao in 1:n.questoes.prova) {

for(turma in 1:n.turmas) {

for(prova in 1:n.provas) {

nome.questao <- mapa.questoes[turma, questao, prova]

  if(nome.questao %in% dimnames(dico[[prova]])[[2]]) {

    dados.balanceamento[, turma, questao,prova, 1] <- as.numeric(Pm.probs[[prova]][, nome.questao])

  }

}

}

}





dados.balanceamento[,,,,2] <- rbinom(n.sim*n.questoes.prova*n.turmas*n.provas, 1, c(dados.balanceamento[,,,,1]))







for (prova in 1:n.provas){

  P.probs[[prova]] <- matrix(0, nrow = nrow(dico[[prova]]), ncol=ncol(dico[[prova]][, -c(1,2)]))

  for (aluno in 1:nrow(dico[[prova]])){



P.probs[[prova]][aluno,] <- c(

  itens.p[[prova]][,3] + (1-itens.p[[prova]][,3])*

    pnorm(itens.p[[prova]][,1]*colMeans(mcmc.theta[[prova]])[aluno] - itens.p[[prova]][,2])

)



P.probs[[prova]] <- data.frame(P.probs[[prova]])

rownames(P.probs[[prova]]) <- colnames(mcmc.theta[[prova]])

colnames(P.probs[[prova]]) <- colnames(dico[[prova]][, -c(1,2)])



        

  }

}







dados.finais <- vector(n.provas, mode="list")



for(prova in 1:n.provas) {

  dados.finais[[prova]] <- array(dim=c(ncol(mcmc.theta[[prova]]), n.turmas, 

                                     n.questoes.prova, 3),

                               dimnames = list(colnames(mcmc.theta[[prova]]),

                               dimnames(mapa.questoes)[[1]],

                               dimnames(mapa.questoes)[[2]],

                               c("Prob.acerto", "Acerto", "Residuo")))

  for(turma in 1:n.turmas) {

    for(questao in 1:n.questoes.prova) {

      nome.questao <- mapa.questoes[turma, questao, prova]

      if(nome.questao %in% dimnames(dico[[prova]])[[2]]) {

        (dados.finais[[prova]][, turma, questao, 1] <-

          as.numeric(P.probs[[prova]][,nome.questao]))}

    }

    dados.finais[[prova]][,,,2] <-

      rbinom(ncol(mcmc.theta[[prova]]), 1, c(dados.finais[[prova]][,,,1]))

    dados.finais[[prova]][,,,3] <- 

      abs(dados.finais[[prova]][,,,2] - dados.finais[[prova]][,,,1])

  }

}





# Probabilidade de um aluno mediano passar por prova

P.am.passar <- array(dim = c(n.turmas, n.provas+1), dimnames = list(dimnames(mapa.questoes)[[1]], c(dimnames(mapa.questoes)[[3]],"Turma")))



for (prova in 1:n.provas){

 for (turma in 1:n.turmas){

  P.am.passar[turma,prova] <- sum(apply(dados.balanceamento[,,,,2], c(1,2,4), sum, na.rm = T)[,turma,prova]>=5)/n.sim

 }

}



P.am.passar[,5] <- dimnames(mapa.questoes)[[1]]







# Medidas decritivas



turma <- list(dados.original$Turma)

medturma <- aggregate(dados.original[,"Nota_prova"],turma,mean)

medturmaprova <- aggregate(dados.original[,"Nota_prova"],list(dados.original$Turma,dados.original$Numero.prova),mean)

colnames(medturmaprova) <- c("Turma", "Prova", "Media")

medcurso <- aggregate(dados.original[,"Nota_prova"],list(dados.original$Curso),mean)

medprova <- aggregate(dados.original[,"Nota_prova"],list(dados.original$Numero.prova),mean)

medano <- aggregate(dados.original[,"Nota_prova"],list(dados.original$Ano),mean)

mediaaluno <- aggregate(dados.original[,"Nota_prova"],list(dados.original$Matricula),mean)

mediaaluno.prova <- aggregate(dados.original[,"Nota_prova"],list(dados.original$Matricula,dados.original$Numero.prova),mean)





# notas dos alunos por prova

notaaluno <- vector(n.provas, mode="list")



for (prova in 1:n.provas) {

 notaaluno[[prova]] <- aggregate(dados.original$Nota_prova[dados.original$Numero.prova==prova],list(dados.original$Matricula[dados.original$Numero.prova==prova]),mean) 

 colnames(notaaluno[[prova]]) <- c("Matricula", "Nota")

}





# notas estimadas por TRI de cada aluno por prova

notas.estimadas <- vector(n.provas, mode="list")





for (prova in 1:n.provas){

theta2 <- mean(notaaluno[[prova]][,2]) + sd(notaaluno[[prova]][,2])*mcmc.theta[[prova]][100,]



thetaajust <- theta2-min(theta2)



notas.estimadas[[prova]] <- array(dim = c(length(dico[[prova]]$matricula),2), dimnames = list(1:length(dico[[prova]]$matricula),c("Matricula","Nota Estimada")))



notas.estimadas[[prova]][,1] <- dico[[prova]]$matricula

notas.estimadas[[prova]][,2] <- c(thetaajust*10/max(thetaajust))

}



# dataframes dos alunos que não passariam e passariam por TRI, em cada prova 

N.passou.hat <- vector(n.provas, mode="list")

Passou.hat <- vector(n.provas, mode="list")



for (prova in 1:n.provas) {

  N.passou.hat[[prova]] <- array(dim = c(length(notas.estimadas[[prova]][notas.estimadas[[prova]]>=0 & notas.estimadas[[prova]]<5]),1), dimnames = list(as.numeric(notas.estimadas[[prova]][,1][notas.estimadas[[prova]][,2]>=0 & notas.estimadas[[prova]][,2]<5]),"Nota Estimada"))

  

  N.passou.hat[[prova]][,1] <- notas.estimadas[[prova]][notas.estimadas[[prova]]>=0 & notas.estimadas[[prova]]<5]

  

  Passou.hat[[prova]] <- array(dim = c(length(notas.estimadas[[prova]][,1][notas.estimadas[[prova]][,2]>=5 ]),1), dimnames = list(as.numeric(notas.estimadas[[prova]][,1][notas.estimadas[[prova]][,2]>=5]),"Nota Estimada"))

 

  Passou.hat[[prova]][,1] <- notas.estimadas[[prova]][,2][notas.estimadas[[prova]][,2]>=5]

}





# dataframes dos alunos que não passaram e passaram, em cada prova 

N.passou <- vector(n.provas, mode="list")

Passou <- vector(n.provas, mode="list")



for (prova in 1:n.provas) {

  N.passou[[prova]] <- array(dim = c(length(notaaluno[[prova]][notaaluno[[prova]]>=0 & notaaluno[[prova]]<5]),1), dimnames = list(as.numeric(notaaluno[[prova]][,1][notaaluno[[prova]][,2]>=0 & notaaluno[[prova]][,2]<5]),"Nota"))

  

  N.passou[[prova]][,1] <- notaaluno[[prova]][notaaluno[[prova]]>=0 & notaaluno[[prova]]<5]

  

  Passou[[prova]] <- array(dim = c(length(notaaluno[[prova]][,1][notaaluno[[prova]][,2]>=5 ]),1), dimnames = list(as.numeric(notaaluno[[prova]][,1][notaaluno[[prova]][,2]>=5]),"Nota"))

 

  Passou[[prova]][,1] <- notaaluno[[prova]][,2][notaaluno[[prova]][,2]>=5]

}





#dataframe com as probabilidades das simulações com theta mediano passar em PE em cada turma



sim.passar <- array(dim = c(n.sim,n.turmas), dimnames = list(paste("Simulacao", 1:n.sim),dimnames(mapa.questoes)[[1]]))



for (simulacao in 1:nchains*(niter/2)){

 for (turma in 1:n.turmas){

  sim.passar[simulacao,turma] <- (sum(apply(dados.balanceamento[,,,,2], c(1,2,4), sum, na.rm = T)[simulacao,turma,])-min(apply(dados.balanceamento[,,,,2], c(1,2,4), sum, na.rm = T)[simulacao,turma,]))/(n.provas-1)

 }

}







# Probabilidade de um aluno mediano passar em PE por turma

P.sim.passar <- array(dim = c(1,n.turmas), dimnames = list("Probabilidade",dimnames(mapa.questoes)[[1]]))



for (turma in 1:n.turmas){

  P.sim.passar[,turma] <- sum(sim.passar[,turma]>=5)/n.sim

}



# Construção de matriz das notas finais

nota.prova <- matrix(0, ncol = n.provas+1, nrow = length(unique(dados.original$Matricula)))

nota.prova[,1] <- unique(dados.original$Matricula)

nota.prova[,2] <- ifelse(unique(dados.original$Matricula) %in% notaaluno[[1]][,1], notaaluno[[1]][,2], 0)

nota.prova[,3] <- ifelse(unique(dados.original$Matricula) %in% notaaluno[[2]][,1], notaaluno[[2]][,2], 0)

nota.prova[,4] <- ifelse(unique(dados.original$Matricula) %in% notaaluno[[3]][,1], notaaluno[[3]][,2], 0)

nota.prova[,5] <- ifelse(unique(dados.original$Matricula) %in% notaaluno[[4]][,1], notaaluno[[4]][,2], 0)

nota.prova <- data.frame(nota.prova)

colnames(nota.prova) <- c("Matricula", "Prova 1", "Prova 2", "Prova 3", "Prova 4")



nota.prova1 <- matrix(0, ncol = n.provas, nrow = length(notaaluno[[1]][,1]))

nota.prova1[,1] <- notaaluno[[1]][,2]

nota.prova1[,2] <- ifelse(notaaluno[[1]][,1] %in% notaaluno[[2]][,1], notaaluno[[2]][,2], -1)

nota.prova1[,3] <- ifelse(notaaluno[[1]][,1] %in% notaaluno[[3]][,1], notaaluno[[3]][,2], -1)

nota.prova1[,4] <- ifelse(notaaluno[[1]][,1] %in% notaaluno[[4]][,1], notaaluno[[4]][,2], -1)

nota.prova1 <- data.frame(nota.prova1)

colnames(nota.prova1) <- c("Prova 1", "Prova 2", "Prova 3", "Prova 4")





media.prova <- matrix(0, ncol = n.provas, nrow = length(nota.prova[,1]))

media.prova[,1] <- nota.prova[,1]

media.prova[,2] <- nota.prova[,2]

media.prova[,3] <- .5*nota.prova[,2] + .5*nota.prova[,3]

media.prova[,4] <- .3*nota.prova[,2] + .3*nota.prova[,3] + .4*nota.prova[,4]



media.prova <- data.frame(media.prova)

colnames(media.prova) <- c("Matricula", "Prova1", "Prova2", "Prova3")



lim.mencao <- c(3, 4.8, 6.8, 8.8)



mencao.m.prova <- matrix("SR", ncol = 4, nrow = length(media.prova$Matricula))

for (prova in 2:4){

 for (aluno in 1:length(media.prova$Matricula)){

  if(media.prova[aluno,prova]>=0 & media.prova[aluno,prova]<lim.mencao[1]){mencao.m.prova[aluno,prova] <- "II"}

  else if(media.prova[aluno,prova]>=lim.mencao[1] & media.prova[aluno,prova]<lim.mencao[2]){mencao.m.prova[aluno,prova] <- "MI"}

  else if(media.prova[aluno,prova]>=lim.mencao[2] & media.prova[aluno,prova]<lim.mencao[3]){mencao.m.prova[aluno,prova] <- "MM"}

  else if(media.prova[aluno,prova]>=lim.mencao[3] & media.prova[aluno,prova]<lim.mencao[4]){mencao.m.prova[aluno,prova] <- "MS"}

  else if(media.prova[aluno,prova]>=lim.mencao[4]){mencao.m.prova[aluno,prova] <- "SS"}

 }

}



mencao.m.prova[,1] <- unique(dados.original$Matricula)



mencao.m.prova <- data.frame(mencao.m.prova)

colnames(mencao.m.prova) <- c("Matricula", "Prova1", "Prova2", "Prova3")



matriz.notas <- cbind(coalesce(nota.prova$`Prova 1`, 0),

                          coalesce(nota.prova$`Prova 2`, 0),

                          coalesce(nota.prova$`Prova 3`, 0),

                          coalesce(nota.prova$`Prova 4`, 0))

    descartada <- pior.prova <- max.col(-matriz.notas, ties.method="last") 

    condicao <- (pior.prova %in% 1:2) & 

      ((matriz.notas[, 4] - matriz.notas[, 3])*4 > (matriz.notas[, 4] - matriz.notas[, pior.prova])*3)

    descartada[condicao] <- 3  

    matriz.notas <- cbind(matriz.notas, descartada=descartada)

    Nota_final <- numeric(nrow(nota.prova))

    for(aluno in 1:nrow(nota.prova)) {

      if (matriz.notas[aluno, 5] %in% 1:2) pesos <- c(3,4,3)/10

      else pesos <- c(3,3,4)/10

      Nota_final[aluno] <- matriz.notas[aluno, -c(matriz.notas[aluno, 5], 5)] %*% pesos

    }

    

    notas.finais <- nota.prova %>%

      mutate(Nota_final=Nota_final) %>%

      arrange(Matricula) %>%

      mutate(Mencao=cut(Nota_final, righ=F, c(0.1,lim.mencao,10.1), 

                        labels=c("II", "MI", "MM", "MS", "SS")))

    



#estimadas por TRI  

    # Construção de matriz das notas finais estimadas

nota.prova.estimada <- matrix(0, ncol = n.provas+1, nrow = length(unique(dados.original$Matricula)))

nota.prova.estimada[,1] <- unique(dados.original$Matricula)

nota.prova.estimada[,2] <- ifelse(unique(dados.original$Matricula) %in% notas.estimadas[[1]][,1], notas.estimadas[[1]][,2], 0)

nota.prova.estimada[,3] <- ifelse(unique(dados.original$Matricula) %in% notas.estimadas[[2]][,1], notas.estimadas[[2]][,2], 0)

nota.prova.estimada[,4] <- ifelse(unique(dados.original$Matricula) %in% notas.estimadas[[3]][,1], notas.estimadas[[3]][,2], 0)

nota.prova.estimada[,5] <- ifelse(unique(dados.original$Matricula) %in% notas.estimadas[[4]][,1], notas.estimadas[[4]][,2], 0)

nota.prova.estimada <- data.frame(nota.prova.estimada)

colnames(nota.prova.estimada) <- c("Matricula", "Prova 1", "Prova 2", "Prova 3", "Prova 4")





matriz.notas.estimadas <- cbind(coalesce(nota.prova.estimada$`Prova 1`, 0),

                          coalesce(nota.prova.estimada$`Prova 2`, 0),

                          coalesce(nota.prova.estimada$`Prova 3`, 0),

                          coalesce(nota.prova.estimada$`Prova 4`, 0))

    descartada <- pior.prova <- max.col(-matriz.notas.estimadas, ties.method="last") 

    condicao <- (pior.prova %in% 1:2) & 

      ((matriz.notas[, 4] - matriz.notas.estimadas[, 3])*4 > (matriz.notas.estimadas[, 4] - matriz.notas.estimadas[, pior.prova])*3)

    descartada[condicao] <- 3  

    matriz.notas.estimadas <- cbind(matriz.notas.estimadas, descartada=descartada)

    Nota_final <- numeric(nrow(nota.prova))

    for(aluno in 1:nrow(nota.prova.estimada)) {

      if (matriz.notas.estimadas[aluno, 5] %in% 1:2) pesos <- c(3,4,3)/10

      else pesos <- c(3,3,4)/10

      Nota_final[aluno] <- matriz.notas.estimadas[aluno, -c(matriz.notas.estimadas[aluno, 5], 5)] %*% pesos

    }

    

    notas.finais.estimadas <- nota.prova.estimada %>%

      mutate(Nota_final=Nota_final) %>%

      arrange(Matricula) %>%

      mutate(Mencao=cut(Nota_final, righ=F, c(0.1,lim.mencao,10.1), 

                        labels=c("II", "MI", "MM", "MS", "SS")))





# Nova variavel para agrupar os cursos

dados.original$Grupo[str_detect(dados.original$Curso,"Engenharia ")] <- 'Engenharia'

dados.original$Grupo[str_detect(dados.original$Curso,"Comp")] <- 'Computação'

dados.original$Grupo[str_detect(dados.original$Curso,"Educ")] <- 'Ed. Física'

dados.original$Grupo[str_detect(dados.original$Curso,"Econ")] <- 'Econômicas'

dados.original$Grupo[str_detect(dados.original$Curso,"Outros")] <- 'Outros'

dados.original$Grupo[is.na(dados.original$Curso)] <- 'NA'



# Comparação das mencoes finais dos alunos que fizeram subs antes e depois desta

nota.3 <- notas.finais[notas.finais$Matricula %in% notaaluno[[3]][,1][notaaluno[[3]][,1] %in% notaaluno[[4]][,1]],4]

nota.subs <- notas.finais[notas.finais$Matricula %in% notaaluno[[3]][,1][notaaluno[[3]][,1] %in% notaaluno[[4]][,1]],5]



mencao.3 <- mencao.m.prova[mencao.m.prova$Matricula %in% notaaluno[[3]][,1][notaaluno[[3]][,1] %in% notaaluno[[4]][,1]],4]

mencao.subs <- notas.finais[notas.finais$Matricula %in% notaaluno[[3]][,1][notaaluno[[3]][,1] %in% notaaluno[[4]][,1]],7]

  

```





#Desempenho dos alunos



```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")



gd <- dados.original %>% 

        group_by(Curso) %>% 

        summarise(Nota_prova = mean(Nota_prova))



color=c(rep("darkblue", sum(str_detect(dados.original$Curso,"Engenharia ")==TRUE, na.rm = T)),"red", rep("purple",2), "green")



dados.original1 <- dados.original



dados.original1$Curso <- factor(dados.original1$Curso, levels = c(unique(dados.original$Curso[str_detect(dados.original$Curso,"Outros")])[-2],

unique(dados.original$Curso[str_detect(dados.original$Curso,"Comp")])[-1],                                unique(dados.original$Curso[str_detect(dados.original$Curso,"Econ")])[-2],     

unique(dados.original$Curso[str_detect(dados.original$Curso,"Educ")])[-2],

unique(dados.original$Curso[str_detect(dados.original$Curso,"Engenharia ")])[-9])[-15])



ggplot(dados.original1, aes(Curso, Nota_prova)) + 

  geom_jitter(position=position_jitter(0.2), alpha=.4, aes(color=Grupo)) +

  stat_summary(aes(y = Nota_prova, group=1), fun.y=mean, colour="black", geom="line",group=1) +

  ylab("Notas") + xlab("Curso") + 

  ggtitle("Notas por Curso") +

  coord_flip() + theme_classic()



```



Nosso primeiro gráfico mostra as notas dos alunos distribuídas de acordo com o Curso, em que foi feito um "jitter" para que se possa observar a quantidade de alunos em cada faixa de menção obtida, além de uma indicação da média geral em cada Curso, representada pela linha preta.



A maioria dos cursos obteve uma média final próxima de 5, Engenharia Civil e Engenharia Mecânica obtiveram média `r round(medcurso[medcurso$Group.1=='Engenharia Civil',2],2)` e `r round(medcurso[medcurso$Group.1=='Engenharia Mecânica',2],2)`, respectivamente, e Computação e Engenharia Ambiental obtiveram as menores notas, `r round(medcurso[medcurso$Group.1=='Computação',2],2)` e `r round(medcurso[medcurso$Group.1=='Engenharia Ambiental',2],2)`.



```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")



medpturma <- matrix(c(rep(c('AA', 'AB', 'BA', 'BB', 'CA', 'CB', 'CC', 'DA', 'DB', 'EA'),4),

                      rep("Media Geral", 4), rep(c(1,2,3,4), each=10), 1,2,3,4, rep(0, 44)),

                    nrow=44, ncol=3)

medpturma[1:40, 3] <- medturmaprova$Media

medpturma[41:44, 3] <- medprova$x

medpturma <- data.frame(medpturma)

colnames(medpturma) <- c("Turma", "Prova", "Media")

medpturma$Media <- as.numeric(as.character(medpturma$Media))



ggplot(medpturma, aes(Prova, Media, color=Turma, group=Turma)) + geom_point() +

  geom_line() + ylim(0,10) + scale_color_manual(values=c(rep("grey",10),'black')) +

  ggtitle("Média das Turmas por Prova e Média Geral") + theme_classic() + theme(legend.position = "none")

```







```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

library(fmsb)

require(dplyr)

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")

#d.tema <- tapply(dados.original$Acertou[dados.original$Turma=='CC'],

#dados.original$Tema[dados.original$Turma=='CC'], sum)



d.tema <- dplyr::filter(dados.original, Numero.prova==1) %>% 

  dplyr::select(Matricula, Acertou, Tema, Turma) 



data <- data.frame(tapply(d.tema$Acertou, list(d.tema$Turma, d.tema$Tema), sum))



tema <- colnames(data)

turma <- rownames(data)

datan <- matrix(0, ncol=ncol(data), nrow=nrow(data))

for (i in 1:n.turmas){

  for (r in 1:10)

    datan[i,r] <- length(d.tema$Tema[d.tema$Turma==turma[i]][d.tema$Tema[d.tema$Turma==turma[i]]==tema[r]])

  

}



data <- data/datan



data1 <- rbind(data[which.max(rowMeans(data, na.rm=T)),], data[which.min(rowMeans(data, na.rm=T)[-c(1,2)]),], rowMeans(data, na.rm=T))

rownames(data1)[3] <- 'Média geral'



# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!

data <- rbind(rep(1,10), rep(0,10) , data)



data1 <- rbind(rep(1,3), rep(0,3) , data1)

 

# plot with default options:



radarchart(data,  axistype=2, pcol=c('red','green','blue','yellow','orange','black','brown','pink','purple','grey'), plwd=1, plty=1, cglcol="grey", cglty=1, caxislabels=seq(0,55,5), axislabcol="grey", cglwd=0.8, vlcex=0.8)

legend(x=1.8, y=1, legend = rownames(data[-c(1,2),]), bty = "n", pch=20 , text.col = c('red','green','blue','yellow','orange','black','brown','pink','purple','grey'),

       col=c('red','green','blue','yellow','orange','black','brown','pink','purple','grey'),

       cex=0.6, pt.cex=1)



radarchart(data1,  axistype=2, pcol=c('blue', 'red','black'), plwd=1, plty=1, cglcol="grey", cglty=1, caxislabels=seq(0,55,5), axislabcol="grey", cglwd=0.8, vlcex=0.8)

legend(x=1.8, y=1, legend = rownames(data1[-c(1,2),]), bty = "n", pch=20 , text.col = c('blue', 'red','black'),

       col=c('blue', 'red','black'),

       cex=0.6, pt.cex=1)

       



```



Interessante observar que na turma `r rownames(data1)[4]` a proporção média de acertos foi a menor, já na turma `r rownames(data1)[3]`, a quantidade de alunos que acertaram em cada tema foi relativamente alta em comparação com as outras turmas. A proporção de acertos de todos os alunos, ou seja, desconsiderando-se turma, está representada pela linha preta.





```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")



prob.v <- c(nrow(mencao.m.prova[mencao.m.prova$Prova2=="MI",][mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MM",][mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MS",][mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="SS",][mencao.m.prova[mencao.m.prova$Prova2=="SS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MI",][mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MM",][mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MS",][mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="SS",][mencao.m.prova[mencao.m.prova$Prova2=="SS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="II",][mencao.m.prova[mencao.m.prova$Prova2=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MI",][mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MM",][mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MS",][mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="II",][mencao.m.prova[mencao.m.prova$Prova2=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MI",][mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MM",][mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MS",][mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="II",][mencao.m.prova[mencao.m.prova$Prova2=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="II",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MI",][mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="II",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova2=="MM",][mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova1=="II",][,1],]),

            

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="SS",][mencao.m.prova[mencao.m.prova$Prova3=="SS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MS",][mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MM",][mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MI",][mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="SS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="SS",][mencao.m.prova[mencao.m.prova$Prova3=="SS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MS",][mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MM",][mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MI",][mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MS",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MS",][mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MM",][mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MI",][mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="II",][mencao.m.prova[mencao.m.prova$Prova3=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MM",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MS",][mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MM",][mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MI",][mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="II",][mencao.m.prova[mencao.m.prova$Prova3=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="MI",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MM",][mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="II",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="MI",][mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="II",][,1],]),

            nrow(mencao.m.prova[mencao.m.prova$Prova3=="II",][mencao.m.prova[mencao.m.prova$Prova3=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova2=="II",][,1],]),

            

            nrow(notas.finais[notas.finais$Mencao=="SS",][notas.finais[notas.finais$Mencao=="SS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="SS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MS",][notas.finais[notas.finais$Mencao=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="SS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MM",][notas.finais[notas.finais$Mencao=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="SS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MI",][notas.finais[notas.finais$Mencao=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="SS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="SS",][notas.finais[notas.finais$Mencao=="SS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MS",][notas.finais[notas.finais$Mencao=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MM",][notas.finais[notas.finais$Mencao=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MI",][notas.finais[notas.finais$Mencao=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MS",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MS",][notas.finais[notas.finais$Mencao=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MM",][notas.finais[notas.finais$Mencao=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MI",][notas.finais[notas.finais$Mencao=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="II",][notas.finais[notas.finais$Mencao=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MM",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MS",][notas.finais[notas.finais$Mencao=="MS",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MM",][notas.finais[notas.finais$Mencao=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MI",][notas.finais[notas.finais$Mencao=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="II",][notas.finais[notas.finais$Mencao=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="MI",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MM",][notas.finais[notas.finais$Mencao=="MM",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="II",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="MI",][notas.finais[notas.finais$Mencao=="MI",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="II",][,1],]),

            nrow(notas.finais[notas.finais$Mencao=="II",][notas.finais[notas.finais$Mencao=="II",][,1] %in% mencao.m.prova[mencao.m.prova$Prova3=="II",][,1],])

            )





library(networkD3)



links <- data.frame(

  source=c("SS1", "SS1", "SS1", "SS1", 

           "MS1", "MS1", "MS1", "MS1", 

           "MM1", "MM1", "MM1", "MM1",

           "MI1", "MI1", "MI1", "MI1", 

           "II1", "II1", "II1",        "SS2", "SS2", "SS2", "SS2",

                                       "MS2", "MS2", "MS2", "MS2",

                                       "MM2", "MM2", "MM2", "MM2", 

                                       "MI2", "MI2", "MI2", "MI2",

                                       "II2", "II2", "II2",         

           "SS3", "SS3", "SS3", "SS3",

           "MS3", "MS3", "MS3", "MS3",

           "MM3", "MM3", "MM3", "MM3", 

           "MI3", "MI3", "MI3", "MI3",

           "II3", "II3", "II3"), 

  

  target=c("MI2", "MM2", "MS2", "SS2",

           "MI2", "MM2", "MS2", "SS2",

           "II2", "MI2", "MM2", "MS2",

           "II2", "MI2", "MM2", "MS2",

           "II2", "MI2", "MM2",        "SS3", "MS3", "MM3", "MI3",               

                                       "SS3", "MS3", "MM3", "MI3",                                                              "MS3", "MM3", "MI3", "II3",                                                              "MS3", "MM3", "MI3", "II3",                                                              "MM3", "MI3", "II3",

           "SS4", "MS4", "MM4", "MI4",               

           "SS4", "MS4", "MM4", "MI4",                                                              "MS4", "MM4", "MI4", "II4",                                                              "MS4", "MM4", "MI4", "II4",                                                              "MM4", "MI4", "II4"), 

  

  value=c(prob.v))



links <- links %>% filter(value>0)



nodes <- data.frame(

  name=c(as.character(links$source), 

  as.character(links$target)) %>% unique(),

  

  name2=substring(c(as.character(links$source), 

    as.character(links$target)) %>% unique(),1,nchar(c(as.character(links$source), 

    as.character(links$target)) %>% unique())-1)

)



links$IDsource <- match(links$source, nodes$name)-1 

links$IDtarget <- match(links$target, nodes$name)-1



links$energy_type <- as.character(links$source)



color_scale <- data.frame(

  range = c(rep(c("darkgreen", "green", "lightgreen", "red", "darkred"),4)),

  domain = c("SS1", "MS1", "MM1", "MI1", "II1", "SS2", "MS2", "MM2", "MI2", "II2",

             "SS3", "MS3", "MM3", "MI3", "II3", "SS4", "MS4", "MM4", "MI4", "II4"),

  nodes = nodes,

  stringsAsFactors = FALSE

)



sankeyNetwork(Links = links, Nodes = nodes,

              Source = "IDsource", Target = "IDtarget",

              Value = "value", NodeID = "name2", 

              LinkGroup = 'energy_type', colourScale = JS(

sprintf(

'd3.scaleOrdinal()  

  .domain(%s)

  .range(%s)

',

jsonlite::toJSON(color_scale$domain),

jsonlite::toJSON(color_scale$range)

   )

  ), fontSize = 15, iteration=0)





```



Podemos observar a evolução das menções atribuídas ao longo do curso, sendo que, na prova 1, há apenas a menção da própria prova; na prova 2, fez-se a média aritmética das duas primeiras notas; na prova 3, calculou-se a nota final de acordo com os pesos atribuídos a cada avaliação e na prova 4, vemos a nota final obtida pelo aluno, após a prova substitutiva.





```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally", "knitr")







tabela <- as.data.frame(table(mencao.3, mencao.subs))

colnames(tabela) <- c("Menção sem P4", "Menção após P4", "Quantidade")

class(tabela$`Menção sem P4`) <- "numeric"

class(tabela$`Menção após P4`) <- "numeric"

class(tabela$Quantidade) <- "numeric"

tabela[, 1:2] <- tabela[, 1:2] - 1

tabela %>% 

  ggplot(aes(`Menção sem P4`, `Menção após P4`)) +

  geom_tile(aes(fill=Quantidade)) +

  scale_fill_gradient(low="white", high="black") +

  scale_x_continuous(breaks=0:4, expand=c(0, 0), labels=c("II","MI","MM","MS","SS")) +

  scale_y_continuous(breaks=0:4, expand=c(0, 0), labels=c("II","MI","MM","MS","SS")) +

  geom_rect(aes(xmin=-.5, xmax=4.5, ymin=-.5, ymax=4.5), 

            color="black", alpha=0, size=1)



```



Esta matriz de confusão compara as menções obtidas somente pelos alunos que fizeram a prova substitutiva, mostrando a menção final antes e depois de a terem feito.





#Avaliações e Banco de Questões



```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")



data.g <- data.frame(Probabilidade=c(as.numeric(P.am.passar[,1]),as.numeric(P.am.passar[,2]),

                       as.numeric(P.am.passar[,3]),as.numeric(P.am.passar[,4])),

                     Turma=c(rep(dimnames(mapa.questoes)[[1]],4)), Prova=rep(c(dimnames(mapa.questoes)[[3]]),each=10))



ggplot(data.g, aes(Turma, Probabilidade, color=Prova, group=Prova)) + geom_point() + geom_line() + ggtitle("Probabilidade de um aluno mediano passar por prova e por turma") +

ylim(0,1) + theme_light()

```



```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")



P.sim.passar <- t(data.frame(P.sim.passar))

P.sim.passar <- data.frame(P.sim.passar,Turma=c(dimnames(mapa.questoes)[[1]]), Linha=c(rep(1,10)))



ggplot(P.sim.passar, aes(Turma, Probabilidade, group=Linha)) + geom_point() + geom_line() + ggtitle("Probabilidade de um aluno mediano passar em PE por turma") + ylim(0,1) +

theme_light()

```



Há uma diferença de `r max(as.numeric(P.am.passar), na.rm = T) - min(as.numeric(P.am.passar), na.rm = T)` entre as probabilidades de que um aluno mediano passe estando matriculado na turma `r rownames(P.am.passar)[as.numeric(ifelse(which.max(P.am.passar)>10,gsub("^?.","",which.max(P.am.passar)),which.max(P.am.passar)))]` ou `r rownames(P.am.passar)[as.numeric(ifelse(which.min(P.am.passar)>10,gsub("^?.","",which.min(P.am.passar)),which.min(P.am.passar)))]` (probabilidade de `r max(as.numeric(P.am.passar), na.rm = T)` na turma `r rownames(P.am.passar)[as.numeric(ifelse(which.max(P.am.passar)>10,gsub("^?.","",which.max(P.am.passar)),which.max(P.am.passar)))]` menos probabilidade de `r min(as.numeric(P.am.passar), na.rm = T)` na turma `r rownames(P.am.passar)[as.numeric(ifelse(which.min(P.am.passar)>10,gsub("^?.","",which.min(P.am.passar)),which.min(P.am.passar)))]`). Mas, quando se leva em conta o resultado final em PE, há uma disparidade menor entre a maior e a menor probabilidade entre as turmas: `r max(P.sim.passar[,1])-min(P.sim.passar[,1])` (`r max(P.sim.passar[,1])` na turma `r rownames(P.sim.passar)[which.max(P.sim.passar[,1])]` e `r min(P.sim.passar[,1])` na turma `r rownames(P.sim.passar)[which.min(P.sim.passar[,1])]`).





#TRI



```{r, echo=FALSE}

library('igraph')

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")





adjm <- as.matrix(cor.tema)

adjm[abs(adjm)<0.3] <- 0



ggcorr(adjm)



network <- graph_from_adjacency_matrix(adjm, weighted=T, diag=F, mode = "undirected")



# Map the color to cylinders

my_color <- c(rep("green", 10),

              rep("blue", 10),

              rep("red", 10))



# plot

par(bg="grey13", mar=c(0,0,0,0))

plot(network, 

    vertex.size=9,

    vertex.color=my_color, 

    vertex.label.cex=0.7,

    vertex.label.color="white",

    vertex.frame.color="transparent"

    )



# title and legend

text(1.1,1,"Tema cluster network",col="white", cex=1.5)

legend(x=1.5, y=1, 

       legend=levels(as.factor(cluster$cluster)), 

       col = c("green", "blue", "red") , 

       bty = "n", pch=20 , pt.cex = 2, cex = 1,

       text.col="white" , horiz = F)



#graphjs(network, vertex.shape = "sphere", left="500px") %>% points3d(vertices(.), color="red", pch=colnames(cd), size=0.1)



```



Esta rede foi obtida a partir do cálculo dos resíduos feito para cada questão feita por cada aluno. O gráfico mostra a associação dos resíduos de cada tema. Há também um correlograma dos temas acima.



```{r, echo=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally")



fviz_cluster(cluster, data=t(cor.tema),

             ggtheme = theme_minimal(),

             main = "Partição dos temas em Clusters"

             )

```



Clusterização feita com uso de Componentes Principais.



```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}

if (!require("pacman")) install.packages("pacman")

pacman::p_load("tidyverse", "dplyr", "tidyr", "reshape2", "irtoys", "ltm", "mirt", "bairt","ggplot2", "R.utils", "igraph", "factoextra", "threejs", "GGally", "knitr")





tabela <- as.data.frame(table(notas.finais$Mencao, notas.finais.estimadas$Mencao))

colnames(tabela) <- c("Classico", "TRI", "Quantidade")

class(tabela$Classico) <- "numeric"

class(tabela$TRI) <- "numeric"

class(tabela$Quantidade) <- "numeric"

tabela[, 1:2] <- tabela[, 1:2] - 1

tabela %>% 

  ggplot(aes(Classico, TRI)) +

  geom_tile(aes(fill=Quantidade)) +

  scale_fill_gradient(low="white", high="black") +

  scale_x_continuous(breaks=0:4, expand=c(0, 0), labels=c("II","MI","MM","MS","SS")) +

  scale_y_continuous(breaks=0:4, expand=c(0, 0), labels=c("II","MI","MM","MS","SS")) +

  geom_rect(aes(xmin=-.5, xmax=4.5, ymin=-.5, ymax=4.5), 

            color="black", alpha=0, size=1)







```



Esta matriz de confusão compara as menções reais obtidas com as menções que seriam atribuídas por TRI. Espera-se que haja uma concentração maior na diagonal.